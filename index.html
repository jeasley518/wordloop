<script>
  let currentWord = 'loop';
  let startWord = 'loop';
  let score = 0;
  let xp = 0;
  let level = 1;
  let timeLeft = 120;
  let timerInterval;
  let hintUsed = false;
  const usedWords = new Set();
  const alphabet = 'abcdefghijklmnopqrstuvwxyz';

  const currentWordDisplay = document.getElementById('current-word');
  const input = document.getElementById('word-input');
  const scoreboard = document.getElementById('scoreboard');
  const timerDisplay = document.getElementById('timer');
  const levelDisplay = document.getElementById('level-display');
  const startWordDisplay = document.getElementById('start-word');
  const correctSound = document.getElementById('correct-sound');
  const wrongSound = document.getElementById('wrong-sound');
  const endSound = document.getElementById('end-sound');
  const hintBtn = document.getElementById('hint-btn');

  // Add CSS for slide-in animation dynamically
  const style = document.createElement('style');
  style.innerHTML = `
    #hint-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-200%);
      background: #fffae5;
      color: #333;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      opacity: 0;
      transition: all 0.5s ease;
      z-index: 1000;
    }

    #hint-message.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  `;
  document.head.appendChild(style);

  const hintMessage = document.createElement('div');
  hintMessage.id = 'hint-message';
  document.body.appendChild(hintMessage);

  async function isValidWord(word) {
    try {
      const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
      return res.ok;
    } catch {
      return false;
    }
  }

  function updateDisplays() {
    scoreboard.textContent = `Score: ${score}`;
    levelDisplay.textContent = `Level: ${level} | XP: ${xp % 100} / 100`;
    startWordDisplay.textContent = `Start word: ${startWord.toUpperCase()}`;
  }

  function resetTimer() {
    clearInterval(timerInterval);
    timeLeft = 120;
    startTimer();
  }

  function startTimer() {
    timerDisplay.textContent = `Time left: ${timeLeft}s`;
    timerInterval = setInterval(() => {
      timeLeft--;
      timerDisplay.textContent = `Time left: ${timeLeft}s`;
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        endSound.play();
        alert(`Time's up! Your score: ${score}`);
      }
    }, 1000);
  }

  function showConfetti() {
    for (let i = 0; i < 30; i++) {
      const confetti = document.createElement("div");
      confetti.className = "confetti";
      confetti.style.left = Math.random() * window.innerWidth + "px";
      confetti.style.top = "-20px";
      confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 60%)`;
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 1500);
    }
  }

  function resetGame(newWord = 'loop') {
    clearInterval(timerInterval);
    currentWord = newWord;
    startWord = newWord;
    score = 0;
    xp = 0;
    level = 1;
    hintUsed = false;
    timeLeft = 120;
    usedWords.clear();
    currentWordDisplay.textContent = currentWord.toUpperCase();
    input.value = '';
    updateDisplays();
    startTimer();
  }

  function showHintMessage(message) {
    hintMessage.textContent = message;
    hintMessage.classList.add("show");
    setTimeout(() => {
      hintMessage.classList.remove("show");
    }, 3000);
  }

  async function getHint(word) {
    for (let i = 0; i < word.length; i++) {
      for (let c of alphabet) {
        if (c !== word[i]) {
          const candidate = word.slice(0, i) + c + word.slice(i + 1);
          if (
            candidate !== word &&
            !usedWords.has(candidate) &&
            await isValidWord(candidate)
          ) {
            return candidate;
          }
        }
      }
    }
    return null;
  }

  document.getElementById('submit-btn').addEventListener('click', async () => {
    const nextWord = input.value.toLowerCase();
    if (
      nextWord.length === currentWord.length &&
      nextWord !== currentWord &&
      [...nextWord].filter((ch, i) => ch !== currentWord[i]).length === 1 &&
      !(usedWords.has(nextWord)) &&
      await isValidWord(nextWord)
    ) {
      currentWord = nextWord;
      currentWordDisplay.textContent = currentWord.toUpperCase();
      usedWords.add(nextWord);
      score++;
      xp += 10;
      if (xp >= level * 100) {
        level++;
        hintUsed = false; // Reset hint use for new level
        showConfetti();
        resetTimer();
      }
      correctSound.play();
      updateDisplays();
      input.value = '';
    } else {
      wrongSound.play();
      alert('Invalid word! Must be real, same length, and one letter different.');
    }
  });

  document.getElementById('new-word-btn').addEventListener('click', () => {
    const randomStartWords = [
      'loop','game','word','test','code','fast','hope','love','fish','bake',
      'rain','road','boat','tree','fire','sand','time','dive','lift','mood',
      'clap','bump','ring','mine','hike','jump','push','pull','fizz','buzz',
      'lamp','frog','grip','mask','bone','vote','zoom','race','lace','ride',
      'send','bond','lend','luck','back','make','pick','hide','mask','fork',
      'bore','chat','grin','plan','cast','flow','seat','trip','wrap','snap',
      'wage','lift','zone','mile','deal','seal','pack','camp','park','claw',
      'flap','brag','stop','grab','yell','roar','maze','quiz','wipe','melt',
      'scan','scar','blur','mint','kick','whip','bank','perk','jazz'
    ];
    const randomWord = randomStartWords[Math.floor(Math.random() * randomStartWords.length)];
    resetGame(randomWord);
  });

  hintBtn.addEventListener('click', async () => {
    if (hintUsed) {
      showHintMessage("You've already used your hint this level!");
      return;
    }
    hintBtn.disabled = true;
    const hint = await getHint(currentWord);
    if (hint) {
      showHintMessage(`Try: ${hint.toUpperCase()}`);
    } else {
      showHintMessage("No valid hints available.");
    }
    hintUsed = true;
    setTimeout(() => {
      hintBtn.disabled = false;
    }, 3000);
  });

  resetGame(currentWord);
</script>