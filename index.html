<script>
  let currentWord = 'loop';
  let startWord = 'loop';
  let score = 0;
  const usedWords = new Set();
  const wordHistory = [];

  const currentWordDisplay = document.getElementById('current-word');
  const input = document.getElementById('word-input');
  const scoreboard = document.getElementById('scoreboard');
  const startWordDisplay = document.getElementById('start-word');
  const wordHistoryDisplay = document.getElementById('word-history');
  const definitionDisplay = document.getElementById('definition');

  function updateDisplays() {
    scoreboard.textContent = `Score: ${score}`;
    startWordDisplay.textContent = `Start word: ${startWord.toUpperCase()}`;
  }

  function updateHistory() {
    wordHistoryDisplay.innerHTML = '';
    wordHistory.forEach(word => {
      const span = document.createElement('span');
      span.textContent = word.toUpperCase();
      span.onclick = () => lookupDefinition(word);
      wordHistoryDisplay.appendChild(span);
    });
  }

  async function isValidWord(word) {
    try {
      const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
      return res.ok;
    } catch {
      return false;
    }
  }

  async function lookupDefinition(word) {
    try {
      const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
      if (res.ok) {
        const data = await res.json();
        const meaning = data[0].meanings[0].definitions[0].definition;
        definitionDisplay.textContent = `${word.toUpperCase()}: ${meaning}`;
      } else {
        definitionDisplay.textContent = `No definition found for ${word.toUpperCase()}.`;
      }
    } catch {
      definitionDisplay.textContent = `Could not load definition.`;
    }
  }

  function resetGame(newWord = 'loop') {
    currentWord = newWord;
    startWord = newWord;
    score = 0;
    usedWords.clear();
    wordHistory.length = 0;
    currentWordDisplay.textContent = currentWord.toUpperCase();
    input.value = '';
    updateDisplays();
    updateHistory();
    definitionDisplay.textContent = '';
  }

  document.getElementById('submit-btn').addEventListener('click', async () => {
    const nextWord = input.value.toLowerCase();
    if (
      nextWord.length === currentWord.length &&
      nextWord !== currentWord &&
      [...nextWord].filter((ch, i) => ch !== currentWord[i]).length === 1 &&
      !usedWords.has(nextWord) &&
      await isValidWord(nextWord)
    ) {
      currentWord = nextWord;
      currentWordDisplay.textContent = currentWord.toUpperCase();
      usedWords.add(nextWord);
      wordHistory.push(nextWord);
      updateHistory();
      score++;
      updateDisplays();
      input.value = '';
      definitionDisplay.textContent = '';
    } else {
      alert('Invalid word! Must be real, same length, and one letter different.');
    }
  });

  document.getElementById('new-word-btn').addEventListener('click', () => {
    const startWords = [
      'loop','game','word','test','code','fast','hope','love','fish','bake','rain',
      'road','boat','tree','fire','sand','time','dive','lift','mood','clap','bump',
      'ring','mine','hike','jump','push','pull','fizz','buzz','lamp','frog','grip',
      'mask','bone','vote','zoom','race','lace','ride','send','bond','lend','luck',
      'back','make','pick','hide','fork','bore','chat','grin','plan','cast','flow',
      'seat','trip','wrap','snap','wage','zone','mile','deal','seal','pack','camp',
      'park','claw','flap','brag','stop','grab','yell','roar','maze','quiz','wipe',
      'melt','scan','scar','blur','mint','kick','whip','bank','perk','jazz'
    ];
    const randomWord = startWords[Math.floor(Math.random() * startWords.length)];
    resetGame(randomWord);
  });

  resetGame(currentWord);
</script>